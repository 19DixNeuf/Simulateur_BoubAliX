using System;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Configuration;
using System.Net;
using System.IO;
using System.Windows;
using System.Windows.Media;
using System.Security.Cryptography;
using System.ComponentModel;




namespace Simulateur
{
    public class GestionSession : INotifyPropertyChanged
    {
        private static readonly log4net.ILog log = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);
        string var_compo;           //Variable permettant la lecture du nombre de voiture
        string var_cab1_active;     //Variable permettant de lire l'état de la cabine 1
        string var_cab2_active;     //Variable permettant de lire l'état de la cabine 2
        string var_session_interdite;//Variable permettant de lire l'état de la session: interdite
        string var_session_authorisee;//Variable permettant de lire l'état de la session: authorisée
        string var_session_ouverte; //Variable permettant de lire l'état de la session: ouverte
        string variableMpuMaitre;   //Variable permettant d'identifier le MPU maître
        string var_mode_train;      //Variable permettant la lecture du monde de conduite du train
        //public string Couleur_etatConnexion; //RTC

        const int déconnecté = 0;
        const int en_cours   = 1;
        const int connecté   = 2;

        FenetreIdentification fenetreIdentification;    //Fenêtre servant à entrer les identifiants de connexion
        Boolean deconnexionDemandee = false;            //Indique lorsqu'une demande de déconnexion a été initiée
        Boolean connexionPerdue = false;                //Flag permettant aux threads de surveillance de session de détecter une coupure de communication
        //Boolean authentificationValidee = false;        //Indique lorsque l'utilisateur est autorisé à interagir ave le train
        Boolean cloturerSession = false;  //Déclencheur d'une fermeture de session
        long tempoFermetureSession = 0;

        Boolean cabineEstActivee = false; // RTC indique qu'une cabine est active
        Boolean avorterConnexion = false;               //flag permettant d'avorter la connexion de l'appli en cas de problème
        ConfigurationTrain cfg;         //Représentation logicielle du train et de ses équipements
        Communication comObj;           //Pointe vers le module de communication du logiciel avec le train
        NameValueCollection readConfig = ConfigurationManager.AppSettings;  //Pointe vers App.config
        //VueConfigurationTrain vueTrain;
        MainWindow IHM;
        MessageBoxResult mbResult;

        static BackgroundWorker _bw;

        Thread Thread_surveillance_connexion;
        Thread Thread_surveillance_session;
        Thread Thread_envoie_bit_de_vie;
        Thread Thread_surveillance_MPU_maitre;

        //Boolean sessionOuverte = false;
        #region Propriétées
        private Boolean _connecte;
        public Boolean connecte
        {
            get
            {
                return _connecte;
            }
            private set
            {
                _connecte = value;
            }
        }
        private Boolean _sessionOuverte;
        public Boolean sessionOuverte
        {
            get
            {
                return _sessionOuverte;
            }
            private set
            {
                _sessionOuverte = value;
            }
        }

        int _etatConnexion;                  //Indique l'état de la connexion (string)
        /// <summary></summary>
        public int etatConnexion             //Indique l'état de la connexion (string)
        {
            get
            {
                return _etatConnexion;
            }
            private set
            {
                _etatConnexion = value;

                switch (_etatConnexion)
                {
                    // configurer l'apparence du label etatConnexion en fonction de l'état de la connexion
                    case connecté:
                        Couleur_etatConnexion = "Blue";
                        etatConnexionContent = "connecté";
                    break;

                    case déconnecté:
                        Couleur_etatConnexion = "Green";
                        etatConnexionContent = "#déconnecté#";
                        break;

                    case en_cours:
                        Couleur_etatConnexion = "Orange";
                        etatConnexionContent = "en cours";
                        break;

                    default:
                        Couleur_etatConnexion = "Grey";
                        etatConnexionContent = "???";
                        break;

                }

                RaisePropertyChanged("etatConnexion");
            }
        }


        // RTC
        string _etatConnexionContent;                  //Indique l'état de la connexion (string)
        /// <summary></summary>
        public string etatConnexionContent             //Indique l'état de la connexion (string)
        {
            get
            {
                return _etatConnexionContent;
            }
            private set
            {
                _etatConnexionContent = value;
                //RaisePropertyChanged("etatConnexion");
            }
        }

        // RTC
        string _Couleur_etatConnexion;                  //Indique l'état de la connexion (string)
        /// <summary></summary>
        public string Couleur_etatConnexion             //Indique l'état de la connexion (string)
        {
            get
            {
                return _Couleur_etatConnexion;
            }
            private set
            {
                _Couleur_etatConnexion = value;
                //RaisePropertyChanged("etatConnexion");
            }
        }           

        string _etatSession;                    //Indique l'état de la session (string)
        public string etatSession
        {
            get
            {
                return _etatSession;
            }
            private set
            {
                _etatSession = value;
                RaisePropertyChanged("etatSession");
            }
        }           //Indique l'état de la session (string)

        private string _labelConnexion;
        public string labelConnexion
        {
            get
            {
                return _labelConnexion;
            }
            set
            {
                _labelConnexion = value;
            }
        }

        private Brush _couleurLabelConnexion;
        public Brush couleurLabelConnexion
        {
            get
            {
                return _couleurLabelConnexion;
            }
            set
            {
                _couleurLabelConnexion = value;
            }
        }

        //Disponibilité du bouton de connexion
        private Boolean _Bouton_Connexion;
        public Boolean Bouton_Connexion
        {
            get
            {
                return _Bouton_Connexion;
            }
            set
            {
                if (_Bouton_Connexion != value)
                {
                    _Bouton_Connexion = value;
                    RaisePropertyChanged("Bouton_Connexion");
                }
            }
        }
        //Disponibilité du bouton d'ouverture de session
        private Boolean _Bouton_Ouvrir_Session;
        public Boolean Bouton_Ouvrir_Session
        {
            get
            {
                return _Bouton_Ouvrir_Session;
            }
            set
            {
                if (_Bouton_Ouvrir_Session != value)
                {
                    _Bouton_Ouvrir_Session = value;
                    RaisePropertyChanged("Bouton_Ouvrir_Session");
                }
            }
        }
        #endregion

        public Boolean cabineEstActive() //RTC
        {
            return cabineEstActivee;

        }


        public Boolean SetcabineEstActive(bool _etat) //RTC
        {

            cabineEstActivee = _etat;

            return cabineEstActivee;

        }

		
        /// <summary>
        /// Constructeur du gestionnaire de session:
        /// initialise la configuration du projet.
        /// </summary>
        public GestionSession()
        {
            IHM = (MainWindow)Application.Current.MainWindow;   //Récupération du "pointeur" vers l'IHM
            long.TryParse(readConfig["tempoFermetureSession"], out tempoFermetureSession);
            //Création et initialisation de la configuration
            cfg = ConfigurationTrain.Instance;
            cfg.initialiser();
            //Lire les variables à utiliser pour,
            var_compo = cfg.lireVariableComposition();            //Connaitre la composition du train
            var_cab1_active = cfg.lireVariableCabine1Active();    //Connaitre l'état de la cabine 1 (active ou non)
            var_cab2_active = cfg.lireVariableCabine2Active();    //Connaitre l'état de la cabine 2 (active ou non)
            var_session_interdite = cfg.lireVariableSessionInterdite();
            var_session_authorisee = cfg.lireVariableSessionAuthorisee();
            var_session_ouverte = cfg.lireVariableSessionOuverte();
            var_mode_train = cfg.lireVariableModeTrain();

            //Initialisation du thread de connexion au train
            _bw = new BackgroundWorker();
            _bw.DoWork += connecter;


            //Vérification de la présence des fichier ETR
            if (!Directory.Exists(readConfig["cheminETR"] + readConfig["dossierETR"]))
            {
                mbResult = MessageBox.Show("Le dossier ETR contenant les paramètres de connexion du train est absent,\n "
                                                            + "Vérifier la présence du fichier à l'endroi spécifié dans le fichier App.config:"
                                                            + readConfig["cheminETR"] + readConfig["dossierETR"],
                                                            "Démarage de session", MessageBoxButton.OK, MessageBoxImage.Stop);

                Bouton_Connexion = false;
            }
            else if (!Directory.Exists(readConfig["cheminETR"] + readConfig["dossierETR"] + "\\" + readConfig["versionETR"]))
            {
                mbResult = MessageBox.Show("Le fichier ETR contenant les paramètres de connexion du train pour la version paramétré est absent,\n "
                                                            + "Vérifier la présence du fichier à l'endroi spécifié dans le fichier App.config.",
                                                            "Démarage de session", MessageBoxButton.OK, MessageBoxImage.Stop);
                Bouton_Connexion = false;
            }
            else
            {
                Bouton_Connexion = true; 
            }
            Bouton_Ouvrir_Session = false;
            etatSession = "Fermée";
            //etatConnexion = "Déconnecté";
            etatConnexion = déconnecté;
            sessionOuverte = false;
        }


        /// <summary>
        /// Lance la connexion avec le train
        /// </summary>
        public void lancerConnexion()
        {
            if (etatConnexion == déconnecté )
            {
                //Mettre à jour le status
                etatConnexion = en_cours;
                //IHM.etatConnexion.Foreground = Brushes.Orange;
                //Lancer le processus de connexion
                _bw.RunWorkerAsync(this);
            }
            
        }
        /// <summary>
        /// Thread de connexion
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        static private void connecter(object sender, DoWorkEventArgs e)
        {
            GestionSession gs;

            Boolean NonclickCancel = true;
            string versionLogicielLu = "";          //Version logicielle lu sur le MPU

            MessageBoxResult mbResult;

            if (e.Argument is GestionSession)
            {
                gs = e.Argument as GestionSession;
                gs.deconnexionDemandee = false;            //flag permettant de gérer l'affichage du status de la connexion à l'écran
                gs.avorterConnexion = false;

                gs.IHM.Afficheur.MessageAffiche = "Connexion en cours";
                //Etablissement de la commnunication avec le train
                gs.comObj = Communication.Instance;
                gs.IHM.Afficheur.MessageAffiche = "lecture configuration ETR"; //RTC
                gs.comObj.init(gs.readConfig["cheminETR"], gs.readConfig["dossierETR"], gs.readConfig["versionETR"]);
                gs.IHM.Afficheur.MessageAffiche = "Connexion au train"; //RTC
                gs.comObj.Connecter(Dns.GetHostEntry(Dns.GetHostName()).AddressList[0].ToString());
                
                //Chercher le MPU maître
                gs.IHM.Afficheur.MessageAffiche = "Recherche MCE Maitre"; //RTC
                Thread.Sleep(3000); // ajout pause dans la connexion
                gs.variableMpuMaitre = gs.cfg.lireVariableMpuMaitre();

                Boolean mpuMaitreTrouve = gs.comObj.rechercherMpuMaitre(gs.variableMpuMaitre);
                if (!mpuMaitreTrouve)
                {
                    gs.mbResult = MessageBox.Show("La connexion avec la cible a échouée!\n "
                                               , "Connexion au train", MessageBoxButton.OK, MessageBoxImage.Stop);
                    log.Warn("Aucun MPU trouvé.");
                    gs.avorterConnexion = true;
                }

                if (!gs.avorterConnexion)
                {
                    gs.IHM.Afficheur.MessageAffiche = "Lecture version logiciel train"; //RTC
                    //Vérifier la version logicielle
                    versionLogicielLu = gs.comObj.LireVersionLogicielMPU();
                    if (versionLogicielLu == "")
                    {
                        mbResult = MessageBox.Show("La lecture de la version logicielle de la cible a échouée!\n ",
                                                "Connexion au train", MessageBoxButton.OK, MessageBoxImage.Stop);
                        log.Warn("La lecture de version MPU a échouée.");
                        gs.avorterConnexion = true;

                    }
                }

                if (!gs.avorterConnexion)
                {
                    gs.IHM.Afficheur.MessageAffiche = "Recherche correspondance version dans simulateur"; //RTC
                    if (versionLogicielLu != gs.readConfig["versionETR"])
                    {
                        //chercher dans le dossier courant un dossier du nom de la version lu
                        if (Directory.Exists(gs.readConfig["cheminETR"] + gs.readConfig["dossierETR"] + "\\" + versionLogicielLu))
                        {
                            //Si il est bien présent, la connexion est réinitialisée
                            gs.comObj.init(gs.readConfig["cheminETR"], gs.readConfig["dossierETR"], versionLogicielLu);
                            gs.comObj.Connecter(Dns.GetHostEntry(Dns.GetHostName()).AddressList[0].ToString());
                        }
                        else
                        {
                            //Afficher un message indiquant que le fichier est manquant
                            mbResult = MessageBox.Show("Le dossier ETR contenant les paramètres de connexion du train ne correspond pas à la version actuelle du train,\n "
                                                                        + "Version configurée: " + gs.readConfig["versionETR"] + "\nVersion train: " + versionLogicielLu
                                                                        , "Connexion au train", MessageBoxButton.OK, MessageBoxImage.Stop);
                            log.Warn("Le dossier ETR contenant les paramètres de connexion du train ne correspond pas à la version actuelle du train,\n "
                                                                        + "Version configurée: " + gs.readConfig["versionETR"] + "\nVersion train: " + versionLogicielLu);

                            //Arreter le logiciel
                            gs.avorterConnexion = true;
                        }
                    }
                }
                if (!gs.avorterConnexion)
                {
                    gs.IHM.Afficheur.MessageAffiche = "Lancement surveillance connexion train"; //RTC
                    //lancer la surveillance de la connexion
                    if (gs.Thread_surveillance_connexion != null)
                    {
                        gs.Thread_surveillance_connexion.Abort();
                    }
                    gs.Thread_surveillance_connexion = new Thread(() => gs.surveillerConnexion(gs));//new ThreadStart(gs.surveillerConnexion));
                    gs.Thread_surveillance_connexion.Start();
                    //_bw_surveillance_connexion.RunWorkerAsync(gs);
                }

                if (!gs.avorterConnexion)
                {
                    gs.IHM.Afficheur.MessageAffiche = "Identification cabine active"; //RTC
                    //Lire puis lancer la configuration train
                    Boolean cabineEstActivee = false;
                    do
                    {
                        object varLu;
                        Boolean cab_1_active = false;
                        Boolean cab_2_active = false;
                        try
                        {
                            cab_1_active = (Boolean)gs.comObj.LireVariable(gs.var_cab1_active);
                            cab_2_active = (Boolean)gs.comObj.LireVariable(gs.var_cab2_active);
                        }
                        catch (Exception ex)
                        {
                            log.Error("Echec de la lecture de la cabine active");
                            log.Debug("Echec de la lecture de la cabine active",ex);
                            gs.IHM.Afficheur.MessageAffiche="Echec de la lecture de la cabine active";
                        }


                        if (cab_1_active)
                        {
                            gs.IHM.Afficheur.MessageAffiche = "Cabine 1 est active"; //RTC
                            varLu = gs.comObj.LireVariable(gs.var_compo);
                            if (!gs.cfg.lireEtatConf())
                            {
                                gs.cfg.lancerConfiguration(varLu.ToString(), 1);
                            }
                            cabineEstActivee = true;
                            gs.SetcabineEstActive(true);//RTC
                        }
                        else if (cab_2_active)
                        {
                            gs.IHM.Afficheur.MessageAffiche = "Cabine 2 est active"; //RTC
                            varLu = gs.comObj.LireVariable(gs.var_compo);
                            if (!gs.cfg.lireEtatConf())
                            {
                                gs.cfg.lancerConfiguration(varLu.ToString(), 2);
                            }
                            cabineEstActivee = true;
                            gs.SetcabineEstActive(true);//RTC
                        }
                        else
                        {
                            mbResult = MessageBox.Show("Aucune cabine active!\n "
                                                   + "Veuillez activer une cabine puis appuyer sur OK",
                                                   "Connexion au train", MessageBoxButton.OKCancel, MessageBoxImage.Stop);

                            NonclickCancel = mbResult != MessageBoxResult.Cancel;

                        }


                    } while (!cabineEstActivee && NonclickCancel);

                    if (!NonclickCancel)
                    {
                        mbResult = MessageBox.Show("Une cabine doit être active pour utiliser le simulateur!\n "
                                                   + "La connexion à la cible est annulée.\n",
                                                   "Connexion au train", MessageBoxButton.OKCancel, MessageBoxImage.Stop);
                        gs.lancerDeconnexion();
                        gs.SetcabineEstActive(false);//RTC
                    }
                    else
                    {
                        //Afficher le synoptique train
                        //gs.vueTrain.lancer();
                        gs.IHM.Afficheur.MessageAffiche = "Connexion réussie";
                        /*System.Windows.Application.Current.Dispatcher.Invoke(System.Windows.Threading.DispatcherPriority.Normal,
                                                           (System.Threading.ThreadStart)delegate
                                                           {
                                                               gs.IHM.btOuvrirSession.IsEnabled = true;
                                                           });
                        */
                        gs.Bouton_Ouvrir_Session = true;
                        //lire le mode de conduite du train
                        object varLu = gs.comObj.LireVariable(gs.var_mode_train);
                        if (varLu is string)
                        {
                            gs.cfg.reglerModeTrain(varLu as string);
                        }
                        

                    }
                }
                if (gs.avorterConnexion)
                {
                    gs.IHM.Afficheur.MessageAffiche = "Echec de la connexion";
                    System.Windows.Application.Current.Dispatcher.Invoke(System.Windows.Threading.DispatcherPriority.Normal,
                                                               (System.Threading.ThreadStart)delegate
                                                               {

                                                                   gs.etatConnexion = déconnecté;
                                                                   //gs.IHM.etatConnexion.Foreground = Brushes.Black;
                                                               });
                    
                }

            }
        }
        /// <summary>
        /// Déconnecte le logiciel du train
        /// </summary>
        public void lancerDeconnexion()
        {
            if (etatConnexion == connecté)
            {
                avorterConnexion = true;
                deconnexionDemandee = true;
                if (comObj != null)
                    comObj.Deconnecter();
                IHM.Afficheur.MessageAffiche = "Train déconnecté";
            }
        }
        /// <summary>
        /// Démarer la fenêtre d'identification
        /// </summary>
        public void lancerIdentification()
        {
            //Demander identification
            fenetreIdentification = new FenetreIdentification(this);
            fenetreIdentification.Show();
        }
        /// <summary>
        /// Lancer la session de formation
        /// </summary>
        public void lancerSession()
        {
            if (!sessionOuverte)
            {
                string cleConsole = string.Empty;      //clé permettant la confirmation de l'ouverture de session via la console
                Boolean lecture_cle_OK = false;
                try
                {
                    //Lire clé sur MPU
                    cleConsole = comObj.LireVariable(cfg.lireVariableCleConfirmation()).ToString();
                    //Afficher clé à l'écran
                    IHM.affichageCleConfirmation.Visibility = Visibility.Visible;
                    IHM.cleConfirmation.Content = cleConsole;
                    //Affiher message 
                    IHM.Afficheur.MessageAffiche = "Entrer la clé de confirmation sur la console de conduite";
                    lecture_cle_OK = true;
                }
                catch (Exception ex)
                {
                    log.Error("Echec de la lecture de la clé de confirmation");
                    log.Debug("Echec de la lecture de la clé de confirmation", ex);
                    IHM.Afficheur.MessageAffiche = "Echec de la lecture de la clé de confirmation";
                }

                if (lecture_cle_OK)
                {
                    Thread_surveillance_session = new Thread(() => surveillerSession(this));//(new ThreadStart(surveillerSession));
                    Thread_surveillance_session.Start();

                }
            }

        }
        /// <summary>
        /// Fermer la session de formation
        /// </summary>
        public void fermerSession()
        {
            cloturerSession = true;
            sessionOuverte = false;
            etatSession = "Fermée";

            if (connecte)
            {
                try
                {
                    comObj.EcrireVariable(cfg.lireVariableFermerSession(), true);
                    log.Info("Fermeture de la session de formation.");
                }
                catch (Exception exe)
                {
                    //Log
                    log.Error("Echec de la fermeture de session de formation");
                    log.Debug("Echec de la fermeture de session de formation",exe);
                }
            }
            System.Windows.Application.Current.Dispatcher.Invoke(System.Windows.Threading.DispatcherPriority.Normal,
                                                                 (System.Threading.ThreadStart)delegate
                                                                 {  
                                                                     IHM.btOuvrirSession.Content = "Ouvrir session";
                                                                     IHM.etatSession.Foreground = Brushes.Black;
                                                                 });
            if (IHM.gScen.Bouton_Valider)
            {
                IHM.gScen.Bouton_Valider = false;
            }
            
        }

        /// <summary>
        /// Surveiller l'état de la connexion avec la cible et l'afficher à l'écran
        /// </summary>
        private void surveillerConnexion(GestionSession gs)

        {
            string etat="";
            string ancien_etat = "";
                //laisser tourner le thread tant que la session est active ou que la connexion a été demandée
                while (((gs.etatSession=="Ouverte") || (gs.etatConnexion!=déconnecté) )&& !gs.deconnexionDemandee)
                {
                    etat = gs.comObj.LireStatusConnection();
                    System.Windows.Application.Current.Dispatcher.Invoke(System.Windows.Threading.DispatcherPriority.Normal,
                                                           (System.Threading.ThreadStart)delegate
                                                           {
                                                               if (gs.deconnexionDemandee)
                                                               {
                                                                   gs.etatConnexion = déconnecté;
                                                                   //gs.IHM.etatConnexion.Foreground = Brushes.Black;
                                                                   gs.connecte = false;
                                                               }
                                                               else
                                                               {
                                                                   
                                                                   if (etat == "OK")
                                                                   {
                                                                       //si il s'agit d'une reconnexion
                                                                       if (ancien_etat != etat)
                                                                       {
                                                                           //MàJ de l'IHM
                                                                           gs.etatConnexion = connecté;
                                                                           //gs.IHM.etatConnexion.Foreground = Brushes.Green;
                                                                           gs.IHM.btConnecter.Content = "Déconnecter";
                                                                           //RTCgs.Bouton_Ouvrir_Session = true;//gs.IHM.btOuvrirSession.IsEnabled = true;
                                                                       }
                                                                       
                                                                       gs.connecte = true;
                                                                   }
                                                                   else
                                                                   {
                                                                       //si il s'agit d'une perte de connexion
                                                                       if (ancien_etat != etat)
                                                                       {
                                                                           gs.etatConnexion = déconnecté;
                                                                           //gs.IHM.etatConnexion.Foreground = Brushes.Black;
                                                                           gs.IHM.btConnecter.Content = "Connecter";
                                                                           gs.Bouton_Ouvrir_Session = false; //gs.IHM.btOuvrirSession.IsEnabled = false;
                                                                       }
                                                                       gs.connecte = false;
                                                                   }
                                                               }

                                                           });
                    ancien_etat = etat;

                }
                System.Windows.Application.Current.Dispatcher.Invoke(System.Windows.Threading.DispatcherPriority.Normal,
                                                               (System.Threading.ThreadStart)delegate
                                                               {
                                                                   gs.Bouton_Ouvrir_Session = false;//gs.IHM.btOuvrirSession.IsEnabled = false;
																	gs.IHM.btConnecter.Content = "connecter";//RTC: pour corriger le bug d'affichage lors d'une annulation de connexion suite à aucune cab en service (gs.deconnexionDemandee=true)
                                                               });
        }
        /// <summary>
        /// Surveillance de la session active
        /// </summary>
        public void surveillerSession(GestionSession gs)
        {
            Boolean enAttenteDuModeFormation = true;
            Boolean sessionOuverte = false;
            gs.connexionPerdue = false;
            gs.cloturerSession = false;
            UInt16 compteur = 0;
            System.Diagnostics.Stopwatch timer = new System.Diagnostics.Stopwatch();

            Boolean session_interdite = false;
            Boolean session_authorisee = false;

            try
            {
                //lecture des jalons de l'ouverture session
                session_interdite = (Boolean)comObj.LireVariable(cfg.lireVariableSessionInterdite());
                session_authorisee = (Boolean)comObj.LireVariable(cfg.lireVariableSessionAuthorisee());

            }
            catch (Exception ex)
            {
                log.Error("Echec de la lecture des conditions d'ouverture de session");
                log.Debug("Echec de la lecture des conditions d'ouverture de session", ex);
                IHM.Afficheur.MessageAffiche = "Echec de la lecture des conditions d'ouverture de session";
            }
            //Lancement de la fonction de suivie si les conditions sont remplies
            if (session_interdite)
            {
                log.Info("Ouverture de session interdite: repréparation du train nécessaire.");
                IHM.Afficheur.MessageAffiche = "Ouverture de session interdite: repréparation du train nécessaire.";
            }
            else if (!session_authorisee)
            {
                log.Info("Ouverture de session non authorisée: vérifier les conditions d'états du train.");
                IHM.Afficheur.MessageAffiche = "Ouverture de session non authorisée: vérifier les conditions d'états du train.";
            }
            else
            {
                //Initialiser thread de surveillance du MPU
                if (gs.Thread_surveillance_MPU_maitre != null)
                {
                    gs.Thread_surveillance_MPU_maitre.Abort();
                }
                gs.Thread_surveillance_MPU_maitre = new Thread(() => gs.surveiller_MPU_maitre(gs));

                do
                {
                    //Si la connexion vient d'être perdue
                    if ((!gs.connecte) && !timer.IsRunning)    
                    {
                        //démarrer timer
                        timer.Start();

                        //Interrompre le scénario en cours
                        if (IHM.gScen.scenarioCourant != null)
                        {
                            if (!IHM.gScen.scenarioCourant.estInterrompu())
                            {
                                IHM.gScen.scenarioCourant.interrompre();
                                //empêcher l'utilisateur d'interagir avec le scénario
                                IHM.gScen.Bouton_Pause = false;
                                IHM.gScen.Bouton_Arreter = false;
                                IHM.gScen.Bouton_Pause_txt = "Continuer";

                                //Avertir l'utilisateur
                                IHM.Afficheur.MessageAffiche = "Connexion interrompue: scénario mis en pause";
                                log.Info("Connexion interrompue: scénario mis en pause");
                            }

                        }
                        else
                        {
                            gs.IHM.Afficheur.MessageAffiche = "Connexion interrompue: tentative de reconnexion...";
                            log.Info("Connexion interrompue: tentative de reconnexion...");
                        }
                        
                    }
                    //Si la perte de connexion est trop longue
                    else if (!gs.connecte && (timer.ElapsedMilliseconds >= tempoFermetureSession) && timer.IsRunning) //parametrable via App.config
                    {
                        //fermer session 
                        gs.cloturerSession = true;
                        //Stopper le timer
                        timer.Stop();
                        //Reset le timer
                        timer.Reset();

                        //Arreter le scénario en cours
                        if (IHM.gScen.scenarioCourant != null)
                        {
                            if(!IHM.gScen.scenarioCourant.estArrete() || !IHM.gScen.scenarioCourant.estInterrompu())//Si le scénario est en cours
                            {
                                IHM.gScen.arreterScenario();
                                //Inhiber les boutons concernant le scénario
                                IHM.gScen.Bouton_Pause=false;
                                IHM.gScen.Bouton_Pause_txt = "Suspendre";
                                IHM.gScen.Bouton_Arreter = false;
                                IHM.Bouton_Quitter = true;
                                //Avertir l'utilisateur
                                IHM.Afficheur.MessageAffiche = "La connexion avec le train est perdue: Repréparation du train nécessaire";
                                MessageBox.Show("La connexion avec le train est perdue: session interrompue\n "
                                                + "L'intégrité des forçages ne peux plus être assuré:\n"
                                                + "une repréparation du train est nécessaire.\n",
                                                "Interruption de la session", MessageBoxButton.OK, MessageBoxImage.Stop);
                            }

                        }
                        else
                        {
                            IHM.Afficheur.MessageAffiche = "La tentative de reconnexion a échouée.";
                        }
                        
                    }
                    //Si la connexion est rétablie
                    else if (gs.connecte && timer.IsRunning)
                    {
                        //Stopper le timer
                        timer.Stop();
                        //Reset le timer
                        timer.Reset();
                        //Réhabiliter l'exécution du code
                        gs.connexionPerdue = false;

                        //si un scénario est sélectionné
                        if (IHM.gScen.scenarioCourant != null)
                        { //Si le scénario est en cours
                            if (!IHM.gScen.scenarioCourant.estArrete())
                            {
                                //Réauthoriser les actions sur les boutons concernant le scénario
                                IHM.gScen.Bouton_Pause = true;      //Réabiliter le bouton pause
                                IHM.gScen.Bouton_Pause_txt = "Continuer";   
                                IHM.gScen.Bouton_Arreter = true;    //Réabiliter le bouton arreter
                                IHM.Bouton_Quitter = false; //empêcher de quitter le logiciel sans s'être déconnecté
                            }

                        }
                        //Avertir l'utilisateur
                        IHM.Afficheur.MessageAffiche = "Connexion avec le train rétablie";

                    }
                    //Si la connexion est bonne
                    else if (gs.connecte)
                    {
                        if (timer.IsRunning)
                        {
                            //reset timer
                            timer.Stop();
                            timer.Reset();
                        }
                        //Lecture de l'état de la session
                        try
                        {
                            sessionOuverte = (Boolean)comObj.LireVariable(cfg.lireVariableSessionOuverte());
                        }
                        catch (SystemException excep)
                        {
                            if (excep is System.NullReferenceException)
                            {
                                gs.connexionPerdue = true;
                            }
                        }

                        

                        if (gs.connecte && !gs.connexionPerdue)
                        {
                            if (sessionOuverte)
                            {
                                //incrémenter et envoyer bit de vie de la session
                                if (compteur != 65535)
                                {
                                    compteur += 1;
                                }
                                else
                                {
                                    compteur = 0;
                                }
                                if (!comObj.EcrireVariable(cfg.lireVariableBitDeVie(), compteur))
                                {
                                    gs.connexionPerdue = true;
                                }
                                if (enAttenteDuModeFormation)
                                {
                                    enAttenteDuModeFormation = false;
                                    //Masquer la clé de confirmation à l'écran
                                    System.Windows.Application.Current.Dispatcher.Invoke(System.Windows.Threading.DispatcherPriority.Normal,
                                                                   (System.Threading.ThreadStart)delegate
                                                                   {
                                                                       IHM.affichageCleConfirmation.Visibility = Visibility.Hidden;
                                                                       IHM.Afficheur.MessageAffiche = "Session de formation ouverte";
                                                                       etatSession = "Ouverte";
                                                                       gs.sessionOuverte = true;
                                                                       IHM.etatSession.Foreground = Brushes.Green;
                                                                       IHM.btOuvrirSession.Content = "Fermer session";
                                                                   });
                                    //démarer la surveillance du MPU
                                    gs.Thread_surveillance_MPU_maitre.Start();
                                }


                            }
                            else if (!sessionOuverte && !enAttenteDuModeFormation)
                            {
                                //Afficher "Mode formation interrompu."
                                mbResult = MessageBox.Show("Mode formation interrompu !\n "
                                                           + "Le scénario et la session de formation ont été arrêté. ",
                                                           "Interruption de la session", MessageBoxButton.OK, MessageBoxImage.Stop);
                                gs.etatSession = "Interrompue";
                                gs.sessionOuverte = false;
                            }
                        }

                    }



                } while (!gs.cloturerSession);
            }
            gs.fermerSession();
            if (gs.connecte)
            {
                gs.IHM.Afficheur.MessageAffiche = "Session fermée.";
            }
            

        }
        /// <summary>
        /// Surveiller le MPU maître
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void surveiller_MPU_maitre(GestionSession gs)
        {
            //Créer un nouveau timer
            System.Diagnostics.Stopwatch timer = new System.Diagnostics.Stopwatch();
            timer.Start();
            //Tant que la session de formation est ouverte
            while (gs.sessionOuverte)
            {
                //Surveiller si le MPU est toujours Maître
                try
                {
                    if (timer.ElapsedMilliseconds >= 5000) //toutes les 5 secondes
                    {
                        if (!(Boolean)gs.comObj.LireVariable(gs.variableMpuMaitre))
                        {
                            MessageBox.Show("Mode formation interrompu !\n "
                                                       + "Le MPU associé à la session de formation n'est plus l'équipement maître.\n "
                                                       + "L'intégrité des forçages ne peux plus être assuré:\n"
                                                       + "Veuiller redémarrer les équipements concernés ou repréparer le train.\n",
                                                       "Interruption de la session", MessageBoxButton.OK, MessageBoxImage.Stop);

                            gs.cloturerSession = true;
                        }
                        timer.Restart();
                    }

                }
                catch (SystemException excep)
                {
                    if (excep is System.NullReferenceException)
                    {
                        gs.connexionPerdue = true;
                    }
                }
            }
        }
        /// <summary>
        /// 
        /// </summary>
        /// <param name="id">identifiant entré par l'utilisateur</param>
        /// <param name="pwd">mot de passe entré par l'utilisateur</param>
        /// <returns>vrai lorsque l'authentification est réussi</returns>
        public Boolean authentifier(string id, string pwd)
        {
            string motdepasse = readConfig[id];
            if (motdepasse == null)
            {
                return false;
            }

            /* //En attente de validation de la méthode d'encryptage
            
            byte[] bytesPwd = System.Text.Encoding.Unicode.GetBytes(pwd);                   //Mot de passe entré
            byte[] bytesPepper = System.Text.Encoding.UTF8.GetBytes(readConfig["pepper"]);  //Code d'entropie
            byte[] bytesConfPwd = System.Text.Encoding.UTF8.GetBytes(readConfig[id]);       //Mot de passe encodé dans BDD
            byte[] securedPwd = ProtectedData.Protect(bytesPwd, bytesPepper, DataProtectionScope.CurrentUser);  //Encodage du mot de passe entré

            //--------------------------------------------------------------------
            string[] lines = { Convert.ToBase64String(securedPwd) };
            System.IO.File.WriteAllLines(@"C:\Users\e_gquill\Documents\visual studio 2013\Projects\GestionSession_latest\hash.txt", lines);
            IHM.errorTextBox.Text = Convert.ToBase64String(securedPwd);
            //--------------------------------------------------------------------
            */
            //Compare both keys
            if (pwd == motdepasse)//bytesConfPwd == securedPwd)
            {
                return true;
            }
            else
            {
                return false;
            }

        }
        /// <summary>
        /// Terminer les threads actifs dans le gestionnaire de session
        /// </summary>
        public void terminer()
        {
            //Fermer les threads de surveillance
            if (Thread_surveillance_connexion != null)
                Thread_surveillance_connexion.Abort();

            if (Thread_surveillance_session != null)
                Thread_surveillance_session.Abort();
            if (Thread_surveillance_MPU_maitre != null)
                Thread_surveillance_MPU_maitre.Abort();
        }



        public event PropertyChangedEventHandler PropertyChanged;
        private void RaisePropertyChanged(string name)
        {

            PropertyChangedEventHandler handler = PropertyChanged;

            if (handler != null)

                handler(this, new PropertyChangedEventArgs(name));

        }

    }
}
